<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>scripts.ggby.xyz</title>
    <link rel="icon" href="favicon.jpg">
    
    <!-- PrismJS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-twilight.min.css" rel="stylesheet" id="prism-theme" />
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --body-bg: #1e1e1e; --text-color: #cccccc; --link-color: #6fa8dc;
            --header-bg: linear-gradient(to bottom, #424242, #2b2b2b);
            --header-text: #ffffff; --border-color: #000000;
            --block-bg-1: #292929; --block-bg-2: #242424;
            --input-bg: #111111; --input-border: #555555; --input-text: #eeeeee;
            --code-border: #333333; --code-bg: #0d0d0d;
        }
        [data-theme="light"] {
            --body-bg: #e1e4f2; --text-color: #000000; --link-color: #22229C;
            --header-bg: #5c7099; --header-text: #ffffff; --border-color: #0b198c;
            --block-bg-1: #f5f5ff; --block-bg-2: #e1e4f2;
            --input-bg: #ffffff; --input-border: #a9b8c2; --input-text: #000000;
        }

        body { background: var(--body-bg); color: var(--text-color); font-family: Verdana, sans-serif; font-size: 10pt; margin: 0; padding: 10px; }
        a { color: var(--link-color); text-decoration: none; cursor: pointer; }
        .page-width { width: 95%; max-width: 1200px; margin: 0 auto; }

        .tborder { background: var(--border-color); width: 100%; margin-bottom: 20px; border: 1px solid var(--border-color); border-spacing: 1px; }
        .thead { background: var(--header-bg); color: var(--header-text); font: bold 11px Tahoma; padding: 6px; }
        .tcat { background: var(--block-bg-2); color: var(--text-color); font: bold 10px Verdana; padding: 6px; }
        .alt1 { background: var(--block-bg-1); padding: 8px; font-size: 11px; }
        .alt2 { background: var(--block-bg-2); padding: 8px; font-size: 11px; }

        .navbar-links { padding: 6px; background: var(--block-bg-1); border: 1px solid var(--border-color); margin-bottom: 15px; font-size: 11px; font-weight: bold; text-align: right; }
        .logo-text { float: left; font-size: 16px; font-weight: bold; }

        input, select, textarea { font: 11px Verdana; color: var(--input-text); background: var(--input-bg); border: 1px solid var(--input-border); padding: 4px; width: 100%; box-sizing: border-box; }
        .button { padding: 3px 10px; background: #444; color: #fff; border: 1px solid #777; cursor: pointer; font: 11px Verdana; margin-top: 5px; }
        [data-theme="light"] .button { background: #d1d1d1; color: #000; border: 1px solid #000; }

        .bbcode-container { border: 1px solid var(--code-border); background: var(--code-bg); margin: 10px 0; }
        .bbcode-header { background: var(--block-bg-2); padding: 4px; font-size: 10px; border-bottom: 1px solid var(--code-border); }
        .code-content-wrapper.collapsed { max-height: 250px; overflow: hidden; position: relative; }
        .code-content-wrapper.collapsed::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 80px; background: linear-gradient(to bottom, transparent, var(--code-bg)); }
        .expand-overlay { display: none; text-align: center; padding: 5px; background: var(--block-bg-2); cursor: pointer; font-size: 10px; border-top: 1px solid var(--code-border); }
        .code-content-wrapper.collapsed + .expand-overlay { display: block; }

        #delete-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: var(--block-bg-1); border: 2px solid var(--border-color); padding: 20px; width: 350px; box-shadow: 0 0 20px #000; }
        .modal-input { margin: 15px 0; text-align: center; font-size: 20px !important; letter-spacing: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="page-width">
    <div class="navbar-links">
        <div class="logo-text">scripts.ggby.xyz <span style="font-size:10px; font-weight:normal;">// admin panel</span></div>
        <a onclick="showList()">[ Threads ]</a> &nbsp;|&nbsp;
        <a onclick="showCreate()">[ New Thread ]</a> &nbsp;|&nbsp;
        <a onclick="toggleTheme()">[ Theme ]</a>
    </div>

    <div id="view-list">
        <table class="tborder" cellpadding="6" cellspacing="1">
            <thead>
                <tr><td class="thead" colspan="4">Database Results</td></tr>
                <tr><td class="tcat">ID</td><td class="tcat">Title</td><td class="tcat">Language</td><td class="tcat">Date</td></tr>
            </thead>
            <tbody id="pastes-container"></tbody>
        </table>
    </div>

    <div id="view-create" class="hidden">
        <form onsubmit="savePaste(event)">
            <table class="tborder" cellpadding="6" cellspacing="1">
                <thead><tr><td class="thead" colspan="2">Post New Source Code</td></tr></thead>
                <tbody>
                    <tr><td class="alt2">Title:</td><td class="alt1"><input type="text" id="title" required></td></tr>
                    <tr>
                        <td class="alt2">Language:</td>
                        <td class="alt1">
                            <select id="language">
                                <option value="cpp">C++</option><option value="csharp">C#</option>
                                <option value="python">Python</option><option value="javascript">JS</option>
                                <option value="lua">Lua</option><option value="text">Text</option>
                            </select>
                        </td>
                    </tr>
                    <tr><td class="alt2">Source:</td><td class="alt1"><textarea id="content" rows="15" required></textarea><button type="submit" class="button" style="float:right">Submit</button></td></tr>
                </tbody>
            </table>
        </form>
    </div>

    <div id="view-detail" class="hidden">
        <table class="tborder" cellpadding="6" cellspacing="1">
            <thead><tr><td class="thead"><span style="float:right" id="detail-date"></span> <span id="detail-title"></span></td></tr></thead>
            <tbody>
                <tr><td class="alt1">
                    <div class="bbcode-container">
                        <div class="bbcode-header"><div style="float:right; cursor:pointer;" onclick="copyCode()" id="copyBtn">[ Copy ]</div>Code:</div>
                        <div class="code-content-wrapper" id="codeWrapper"><pre><code id="detail-code"></code></pre></div>
                        <div class="expand-overlay" onclick="expandCode()">▼ EXPAND ▼</div>
                    </div>
                    <div style="text-align:right;">
                        <button class="button" onclick="showList()">Back</button>
                        <button class="button" style="color:red" onclick="askDeletePermissions()">Delete Thread</button>
                    </div>
                </td></tr>
            </tbody>
        </table>
    </div>

    <div id="delete-modal" class="hidden">
        <div class="modal-content">
            <div class="thead" style="margin:-20px -20px 15px -20px; padding:8px;">Security Verification</div>
            <p style="font-size:11px;">Code sent to admin emails. Enter it to confirm:</p>
            <input type="text" id="verification-code-input" class="modal-input" placeholder="000000" maxlength="6">
            <div style="display:flex; justify-content:space-between;">
                <button class="button" onclick="closeDeleteModal()">Cancel</button>
                <button class="button" id="confirm-delete-btn" style="color:red" onclick="verifyAndExecuteDelete()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<script>
    const SUPABASE_URL = 'https://elimtydusdxllztjiwlx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsaW10eWR1c2R4bGx6dGppd2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5OTA0NzYsImV4cCI6MjA4NDU2NjQ3Nn0.lS3AI4mV0l-rrk2aCF0C22EY7_334LvjA2FM8Xbe5R0';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    (function() { emailjs.init("CEtF6_3RJQ5bNsJL3"); })();

    let currentPasteId = null;
    let generatedCode = null;

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        document.getElementById('prism-theme').href = next === 'dark' ? 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-twilight.min.css' : 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css';
    }

    function showList() { hideAll(); document.getElementById('view-list').classList.remove('hidden'); loadPastes(); }
    function showCreate() { hideAll(); document.getElementById('view-create').classList.remove('hidden'); }
    function hideAll() { document.getElementById('view-list').classList.add('hidden'); document.getElementById('view-create').classList.add('hidden'); document.getElementById('view-detail').classList.add('hidden'); closeDeleteModal(); }

    async function loadPastes() {
        const { data } = await supabaseClient.from('pastes').select('*').order('id', { ascending: false });
        document.getElementById('pastes-container').innerHTML = data.map(p => `<tr><td class="alt2" align="center">${p.id}</td><td class="alt1"><b><a onclick="fetchOne(${p.id})">${p.title}</a></b></td><td class="alt2" align="center">${p.language}</td><td class="alt1" align="center">${new Date(p.created_at).toLocaleDateString()}</td></tr>`).join('');
    }

    async function fetchOne(id) {
        const { data } = await supabaseClient.from('pastes').select('*').eq('id', id).single();
        if (data) {
            currentPasteId = data.id; hideAll();
            document.getElementById('view-detail').classList.remove('hidden');
            document.getElementById('detail-title').innerText = data.title;
            const code = document.getElementById('detail-code');
            code.className = 'language-' + data.language;
            code.textContent = data.content;
            Prism.highlightElement(code);
            const wrp = document.getElementById('codeWrapper'); wrp.classList.remove('collapsed');
            if(data.content.split('\n').length > 15) wrp.classList.add('collapsed');
        }
    }

    async function savePaste(e) {
        e.preventDefault();
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        const language = document.getElementById('language').value;
        await supabaseClient.from('pastes').insert([{ title, content, language }]);
        showList();
    }

    // === SECURITY LOGIC ===
    async function askDeletePermissions() {
        generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('delete-modal').classList.remove('hidden');
        const btn = document.getElementById('confirm-delete-btn');
        btn.innerText = "Sending Code..."; btn.disabled = true;

        try {
            // ИСПОЛЬЗУЕМ ВАШ НОВЫЙ ТЕМПЛЕЙТ ID
            await emailjs.send('service_pxxsu9s', 'template_lbubwng', {
                code: generatedCode,
                message: "Delete Request ID: " + currentPasteId
            });
            btn.innerText = "Verify & Delete"; btn.disabled = false;
        } catch (err) {
            alert("EmailJS Error: " + JSON.stringify(err));
            closeDeleteModal();
        }
    }

    async function verifyAndExecuteDelete() {
        if (document.getElementById('verification-code-input').value === generatedCode) {
            await supabaseClient.from('pastes').delete().eq('id', currentPasteId);
            showList();
        } else { alert("Wrong code!"); }
    }

    function closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); document.getElementById('verification-code-input').value = ''; }
    function expandCode() { document.getElementById('codeWrapper').classList.remove('collapsed'); }
    function copyCode() { navigator.clipboard.writeText(document.getElementById('detail-code').textContent); }

    window.onload = loadPastes;
</script>
</body>
</html>
